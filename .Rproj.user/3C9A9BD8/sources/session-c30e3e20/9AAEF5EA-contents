# Worldwide Bureaucracy Indicators
# 01. Data processing

### Libraries

library(haven)
library(dplyr)
library(tidyr)
library(stringr)
library(labelled)
library(readxl)
library(data.table)
library(lubridate)

### Loading data ----

# Load the data sets

data <- read_excel("C:/Users/wb631166/OneDrive - WBG/Desktop/Bureaucracy Lab/WWBI/Worldwide Bureaucracy Indicators (WWBI) Version 3.1.xlsx", 
                   sheet = "Data") #61004 obs


#Load GDP pc IMF for countries

gdp_pc <-  read_excel("C:/Users/wb631166/OneDrive - WBG/Desktop/Bureaucracy Lab/WWBI/Data/Intermediate/IMF_GDP.xls", 
                      sheet = "gdp") #228 obs


#Transform the data sets into a data.table

data_table <- as.data.table(data)

data_table_gdp <- as.data.table(gdp_pc)

#View data

View(data_table)
head(data_table)
n_distinct(data_table)
nrow(data_table) # 61004 observations 
glimpse(data_table)


#View data gdp

View(data_table_gdp)
head(data_table_gdp)
n_distinct(data_table_gdp)
nrow(data_table_gdp) # 228 observations 
glimpse(data_table_gdp)

# Rename columns with small letters

setnames(data_table, tolower(names(data_table)))


setnames(data_table_gdp, tolower(names(data_table_gdp)))


# Rename all columns that start with a number by adding a "year_" prefix

setnames(data_table, old = names(data_table), new = ifelse(grepl("^[0-9]", names(data_table)), paste0("year_", names(data_table)), names(data_table)))


setnames(data_table_gdp, old = names(data_table_gdp), new = ifelse(grepl("^[0-9]", names(data_table_gdp)), paste0("year_", names(data_table_gdp)), names(data_table_gdp)))

# Replace special characters columns

setnames(data_table, gsub("[^[:alnum:]_]", "_", names(data_table)))

setnames(data_table_gdp, gsub("[^[:alnum:]_]", "_", names(data_table_gdp)))

#Rename column for gdp data base

setnames(data_table_gdp, old = "gdp_per_capita__current_prices___u_s__dollars_per_capita_", new = "country_name")

# Round all numeric columns to 2 decimal places gdp data base

numeric_cols <- names(dt)[sapply(dt, is.numeric)] # Identify numeric columns
dt[, (numeric_cols) := lapply(.SD, round, 2), .SDcols = numeric_cols]


#Transform data.table to a data.frame

data_wwbi<- as.data.frame(data_table)

# Save the project data 

write_dta(data_wwbi, file.path(data_path, "Data/Intermediate/data_wwbi.dta"))

